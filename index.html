<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BT & EE Text Generator</title>
    <style>
        :root {
            --bt-primary: #6200EE;
            --bt-primary-hover: #5300d6;
            --ee-primary: #009999;
            --ee-primary-hover: #007a7a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
            height: 50px;
        }
        .logo-container svg {
            height: 100%;
            width: auto;
        }
        h1 {
            color: #1a2533;
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
        }
        label {
            display: block;
            font-weight: 600;
            color: #3b4d61;
            margin-bottom: 8px;
        }
        select, textarea, input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #dbe2e8;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea { margin-top: 10px; height: 180px; resize: vertical; background-color: #f8f9fa; }
        button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .status { text-align: center; margin-top: 15px; color: #28a745; font-weight: 500; height: 20px; }
        .filter-selector { display: flex; justify-content: center; margin-bottom: 15px; border: 1px solid #dbe2e8; border-radius: 6px; overflow: hidden; }
        .filter-selector label, .filter-selector .button-like {
            flex: 1;
            text-align: center;
            padding: 12px;
            margin: 0;
            cursor: pointer;
            background-color: #f8f9fa;
            color: #555;
            transition: background-color 0.2s, color 0.2s;
            border: none;
            font-size: 16px;
            font-family: inherit;
        }
        .filter-selector input[type="radio"] { display: none; }
        .filter-selector input[type="radio"]:checked + label { color: white; }
        
        #charCounter { text-align: right; color: #555; font-size: 14px; margin-top: 5px; height: auto; }
        .feedback-text { text-align: center; margin-top: 20px; font-size: 14px; color: #6c757d; }
        .feedback-text a { text-decoration: none; }
        .feedback-text a:hover { text-decoration: underline; }
        .hidden { display: none; }

        /* --- Step Styling --- */
        .step-container { margin-bottom: 15px; }

        /* --- Custom Search/Select Input --- */
        .custom-select-container { position: relative; }
        .scenario-dropdown {
            display: none;
            position: absolute;
            background-color: #f6f6f6;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 6px;
            z-index: 1;
            max-height: 250px;
            overflow-y: auto;
        }
        .scenario-dropdown.show { display: block; }
        .scenario-dropdown div { padding: 12px 16px; cursor: pointer; display: block; }
        .scenario-dropdown div:hover { background-color: #e9e9e9; }
        .scenario-dropdown .category-label {
            font-weight: bold; padding: 10px 16px 5px; color: #555;
            font-size: 14px; background-color: #f0f0f0;
        }

        /* --- Contextual Options --- */
        .contextual-options { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border: 1px solid #dbe2e8; }
        .datetime-inputs { display: flex; gap: 10px; }
        .contextual-options button { margin-top: 10px; padding: 10px; font-size: 14px; }

        /* --- Theme Styling --- */
        .theme-bt button { background-color: var(--bt-primary); }
        .theme-bt button:hover { background-color: var(--bt-primary-hover); }
        .theme-bt .filter-selector input[type="radio"]:checked + label { background-color: var(--bt-primary); }
        .theme-bt .step-summary { background-color: var(--bt-primary); }
        .theme-bt #logo-ee, .theme-bt.container #logo-ee { display: none; }
        .theme-bt #logo-bt, .theme-bt.container #logo-bt { display: block; }
        .theme-bt .feedback-text a { color: var(--bt-primary); }

        .theme-ee button { background-color: var(--ee-primary); }
        .theme-ee button:hover { background-color: var(--ee-primary-hover); }
        .theme-ee .filter-selector input[type="radio"]:checked + label { background-color: var(--ee-primary); }
        .theme-ee .step-summary { background-color: var(--ee-primary); }
        .theme-ee #logo-bt, .theme-ee.container #logo-bt { display: none; }
        .theme-ee #logo-ee, .theme-ee.container #logo-ee { display: block; }
        .theme-ee .feedback-text a { color: var(--ee-primary); }
    </style>
</head>
<body>

    <div id="appContainer" class="container">
        <div class="logo-container">
            <svg id="logo-bt" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="var(--bt-primary)">
                <circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/>
                <text x="50" y="68" font-family="Arial, Helvetica, sans-serif" font-size="50" font-weight="bold" text-anchor="middle" fill="currentColor">BT</text>
            </svg>
            <svg id="logo-ee" viewBox="0 0 80 40" xmlns="http://www.w3.org/2000/svg" fill="var(--ee-primary)">
                <text x="0" y="32" font-family="Arial, Helvetica, sans-serif" font-size="40" font-weight="bold" fill="currentColor">EE</text>
            </svg>
        </div>
        <h1>Text Generator</h1>

        <!-- Quick Start Options -->
        <div id="quick-start-container">
            <label>Quick Start:</label>
            <div class="filter-selector">
                <button id="quickStartBT" class="button-like">BT Delay (Contact Made)</button>
                <button id="quickStartEE" class="button-like">EE Delay (Contact Made)</button>
            </div>
        </div>

        <!-- Step 1: Brand -->
        <div id="step-brand" class="step-container">
            <div id="summary-brand" class="step-summary hidden"></div>
            <div id="content-brand" class="step-content">
                 <label>Select a brand:</label>
                <div class="filter-selector">
                    <input type="radio" id="brandBT" name="brand" value="BT">
                    <label for="brandBT">BT</label>
                    <input type="radio" id="brandEE" name="brand" value="EE">
                    <label for="brandEE">EE</label>
                </div>
            </div>
        </div>

        <!-- Step 2: Pre-Text or Post-Text -->
        <div id="step-type" class="step-container hidden">
            <div id="summary-type" class="step-summary hidden"></div>
            <div id="content-type" class="step-content">
                <label>What type of message are you sending?</label>
                <div class="filter-selector">
                    <input type="radio" id="typePre" name="type" value="pre">
                    <label for="typePre">Pre-Text</label>
                    <input type="radio" id="typePost" name="type" value="post">
                    <label for="typePost">Post-Text</label>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Post-Text Category -->
        <div id="step-category" class="step-container hidden">
            <div id="summary-category" class="step-summary hidden"></div>
            <div id="content-category" class="step-content">
                 <label>Select a category:</label>
                <div class="filter-selector">
                    <input type="radio" id="catAll" name="category" value="All">
                    <label for="catAll">All</label>
                    <input type="radio" id="catDelays" name="category" value="Delays">
                    <label for="catDelays">Delays</label>
                    <input type="radio" id="catSetUps" name="category" value="Set Up / General">
                    <label for="catSetUps">Set Up / General</label>
                </div>
            </div>
        </div>

        <!-- Step 4: Post-Text Contact Status -->
        <div id="step-contact" class="step-container hidden">
            <div id="summary-contact" class="step-summary hidden"></div>
            <div id="content-contact" class="step-content">
                 <label>Was contact made with the customer?</label>
                <div class="filter-selector">
                    <input type="radio" id="contactYes" name="contactStatus" value="Yes">
                    <label for="contactYes">Contact Made</label>
                    <input type="radio" id="contactNo" name="contactStatus" value="No">
                    <label for="contactNo">No Contact</label>
                </div>
            </div>
        </div>
        
        <!-- Final Step: Scenario Selection & Output -->
        <div id="step-scenario" class="hidden">
            <label for="scenarioInput">Select a message template:</label>
            <div class="custom-select-container">
                <input type="text" id="scenarioInput" placeholder="Type or click to select...">
                <div id="scenarioDropdown" class="scenario-dropdown"></div>
            </div>

            <div id="delay-options" class="contextual-options hidden">
                <label for="delayStartDate">Delay Identified On:</label>
                <input type="date" id="delayStartDate">
            </div>
            
            <textarea id="messageOutput" placeholder="Your generated message will appear here..."></textarea>
            <div id="charCounter"></div>

            <div id="callback-options" class="contextual-options hidden">
                <label>Select Date and Time for Callback:</label>
                <div class="datetime-inputs">
                    <input type="date" id="callbackDate">
                    <select id="callbackTime"></select>
                </div>
                <button id="insertDateTime">Insert Date & Time</button>
            </div>
            
            <button id="copyButton">Copy Message</button>
            <div id="statusMessage" class="status"></div>
        </div>
        
        <p class="feedback-text">Any feedback is welcome, please email me: <a href="mailto:calumbarnes@ee.co.uk">calumbarnes@ee.co.uk</a></p>
    </div>

<script>
    // --- DATA STORE ---
    const scenarios = {
        pre: [
            { id: 'general_call', dropdownText: 'General Account Call', bt_template: `regarding your account. I'll try calling you in the next few minutes from an 0800 number.`, ee_template: `regarding your account. I'll try calling you in the next few minutes from an 0800 number.` },
            { id: 'order_issue', dropdownText: 'Issue With Order', bt_template: `we need to discuss an issue with your recent order. I'll be calling you shortly from an 0800 number to go over the details.`, ee_template: `we need to discuss an issue with your recent order. I'll be calling you shortly from an 0800 number to go over the details.` },
            { id: 'order_update', dropdownText: 'Order Progress Update', bt_template: `I'm calling to provide a progress update on your order. I'll try your number in the next few minutes from an 0800 number.`, ee_template: `I'm calling to provide a progress update on your order. I'll try your number in the next few minutes from an 0800 number.` },
            { id: 'engineer_booking', dropdownText: 'Book Engineer Visit', bt_template: `I'm calling to book in your engineer appointment to get your new service installed. I'll call you in the next few minutes from an 0800 number.`, ee_template: `I'm calling to book in your engineer appointment to get your new service installed. I'll call you in the next few minutes from an 0800 number.` },
            { id: 'engineer_reminder', dropdownText: 'Engineer Appointment Reminder', bt_template: `I'm calling with a quick reminder about your scheduled engineer visit. I'll be calling shortly from an 0800 number to confirm the details and answer any questions.`, ee_template: `I'm calling with a quick reminder about your scheduled engineer visit. I'll be calling shortly from an 0800 number to confirm the details and answer any questions.` },
            { id: 'query_follow_up', dropdownText: 'Follow Up On A Query', bt_template: `I'm following up on your recent query. I will be calling you shortly from an 0800 number to discuss this further.`, ee_template: `I'm following up on your recent query. I will be calling you shortly from an 0800 number to discuss this further.` },
            { id: 'complaint_follow_up', dropdownText: 'Follow Up On A Complaint', bt_template: `regarding your recent complaint. I will be calling you in the next few minutes from an 0800 number to discuss how we can resolve this for you.`, ee_template: `regarding your recent complaint. I will be calling you in the next few minutes from an 0800 number to discuss how we can resolve this for you.` }
        ],
        post: [
            { id: 'ducting_issue', category: 'Delays', dropdownText: 'External Ducting Issue (12 Weeks)', delayDays: 60, bt_template: `We're sorry to let you know that there are some issues with the external ducting for your BT service, but please be assured we've already tasked our contractors with sorting it out. It's quite a complex job, so we're estimating it may take up to 12 weeks to fully resolve.\n\nHowever, we promise to keep you updated along the way and aim to provide you with an update no later than 9 PM on the {date}.\n\nYou can find a helpful booklet here: https://care.bt.com/next_steps`, ee_template: `We've hit a snag with some external ducting work for your new EE Full Fibre service. It's a tricky issue that our network partners are working to resolve. We expect this to be sorted within 12 weeks.\n\nYour next update will be scheduled for {date}. We're sorry for the delay and appreciate your patience.\n\nAs an EE customer, you can use BT/EE WIFI hotspots for free while you wait. Find out more here: https://ee-wifi.ee.co.uk/public/ee/help/index.htm` },
            { id: 'engineer_shortage', category: 'Delays', dropdownText: 'Engineer Shortage (4 Weeks)', delayDays: 20, bt_template: `We're writing to inform you of a slight delay to your BT installation due to an unexpected regional shortage of specialist engineers. We are actively reallocating resources and expect to have an engineer with you within 4 weeks. We will provide a confirmed installation date no later than {date}. We sincerely apologize for the inconvenience this may cause.`, ee_template: `We're writing to inform you of a slight delay to your EE installation due to an unexpected regional shortage of specialist engineers. We are actively reallocating resources and expect to have an engineer with you within 4 weeks. We will provide a confirmed installation date no later than {date}. We sincerely apologize for the inconvenience this may cause.` },
            { id: 'wayleave_delay', category: 'Delays', dropdownText: 'Wayleave/Permit Delay (8 Weeks)', delayDays: 40, bt_template: `There has been a delay in progressing your BT order as we require legal permission, known as a wayleave, to install our equipment on private land. This process can be lengthy and involves multiple parties. We are working to get this approved as quickly as possible and estimate a resolution within 8 weeks. Your next formal update will be on or before {date}. Thank you for your patience.`, ee_template: `There has been a delay in progressing your EE order as we require legal permission, known as a wayleave, to install our equipment on private land. This process can be lengthy and involves multiple parties. We are working to get this approved as quickly as possible and estimate a resolution within 8 weeks. Your next formal update will be on or before {date}. Thank you for your patience.` },
            { id: 'damaged_cabinet', category: 'Delays', dropdownText: 'Damaged Cabinet (12 Weeks)', delayDays: 60, bt_template: `Hello. We've identified a fault in the network, but we've already assigned an engineer to work on getting it resolved. It's a complex job, so it may take up to twelve weeks to fully fix. We'll be in touch with regular updates and will provide you with an update no later than 9 PM on {date}.\n\nPlease read this handy booklet for more detail on the work required to get you your new service: https://care.bt.com/next_steps. As a BT Customer, you can also access BT WiFi hotspots free of charge anywhere in the UK while you wait. This brilliant booklet will provide all the information you need: https://care.bt.com/_bt_wifi_hotspots`, ee_template: `Hi there, we wanted to let you know that we've identified a network fault affecting your EE service. We've already assigned an engineer to work on it. It's a complex job, so it might take up to twelve weeks to fully fix. We'll be in touch with regular updates and aim to provide you with an update no later than 9 PM on {date}.\n\nAs an EE customer, you can use BT/EE WIFI hotspots for free while you wait. Find out more here: https://ee-wifi.ee.co.uk/public/ee/help/index.htm` },
            { id: 'damaged_pole', category: 'Delays', dropdownText: 'Damaged Pole (12 Weeks)', delayDays: 60, bt_template: `Hello. We've found a damaged pole in our network that's affecting your property. Our civils and engineering teams are already working hard to fix it. It's a significant job, so it may take up to 12 weeks to fully resolve.\n\nWe promise to keep you updated along the way, and we'll get in touch with another update no later than 9 PM on {date}.\n\nPlease read this handy booklet for more detail on the work required to get you your new Full Fibre service: https://care.bt.com/next_steps. As a BT Customer, you can also access BT WiFi hotspots free of charge anywhere in the UK while you wait. This brilliant booklet will provide all the information you need: https://care.bt.com/_bt_wifi_hotspots`, ee_template: `Hi there. We've found a damaged pole in the network that's affecting your property. Our civils and engineering teams are already working to fix it. It's a big job, so it might take up to 12 weeks to fully resolve.\n\nWe promise to keep you updated, and we'll get in touch with another update no later than 9 PM on {date}.\n\nAs an EE customer, you can use BT/EE WIFI hotspots for free while you wait. Find out more here: https://ee-wifi.ee.co.uk/public/ee/help/index.htm` },
            { id: 'smart_hub_setup', category: 'Set Up / General', dropdownText: 'Smart Hub Set Up Guide', delayDays: 0, bt_template: `Hi there! It was great speaking with you today. I wanted to follow up and share a helpful guide on how to set up your new BT Smart Hub. This guide will walk you through everything you need to know to get started and enjoy your superfast internet services as soon as they're connected. Check it out here:\n\nhttps://www.bt.com/help/home/broadband/set-up/bt-smart-hub-how-to-set-up\n\nLet me know if you have any questions or if there's anything else I can assist you with.`, ee_template: `Hi there! It was great speaking with you today. I wanted to follow up and share a helpful guide on how to set up your new EE Smart Hub. This guide will walk you through everything you need to know to get started. Check it out here:\n\nhttps://ee.co.uk/help/broadband/getting-started/setting-up-your-smart-hub\n\nLet me know if you have any questions.` },
            { id: 'mini_hub_setup', category: 'Set Up / General', dropdownText: 'Mini Hub Set Up Guide', delayDays: 0, bt_template: `Hello there! It was great speaking with you today. I'm sorry to hear about the delay in your fibre installation, but we have good news. We have placed an order for one of our 4G mini hubs for you. Once you receive it, please follow this helpful guide on how to use it. It will keep you connected while you wait for your fibre installation. Plus, it has unlimited data so you can continue using it worry-free.\n\nHere's the link to the guide: https://www.bt.com/help/mobile/4g-mini-hub`, ee_template: `Hello there! It was great speaking with you today. I'm sorry to hear about the delay in your fibre installation. We have good news: we've ordered a 4G mini hub for you. Once you receive it, this guide shows you how to use it to stay connected with unlimited data while you wait.\n\nHere's the link to the guide: https://ee.co.uk/help/mobile/get-started/smart-benefits/what-is-the-4g-mini-hub-and-how-do-i-use-it` },
            { id: 'download_app', category: 'Set Up / General', dropdownText: 'Download the App Guide', delayDays: 0, bt_template: `Hi there! It was great speaking with you today. In case you weren't already aware, you can download our handy MyBT app, which allows you to easily manage your BT account. With this app, you can track orders, view your bills, and even run tests on your connection to ensure you're getting the most out of your BT services.\n\nHere's the link to download the app: https://home.bt.com/tech-gadgets/internet/manage-your-bt-account-quickly-and-easily-with-the-new-my-bt-app-11363997056591`, ee_template: `Hi there! It was great speaking with you today. You can easily manage your EE account with our handy My EE app. With the app, you can track orders, view your bills, and check your connection status.\n\nHere's the link to download the app: https://ee.co.uk/myee/app` },
            { id: 'call_back', category: 'Set Up / General', dropdownText: 'Arrange a Call Back', delayDays: 0, bt_template: `Hi there, I am really sorry for the experience you have had up to now. I want to assure you I will be calling back on `, ee_template: `Hi there, I'm sorry for the experience you've had so far. I want to assure you I will be calling you back on ` },
            { id: 'great_to_speak', category: 'Set Up / General', dropdownText: 'Great to Speak to You Follow-up', delayDays: 0, bt_template: `Hi there, It was great to speak to you today, and I hope everything is sorted now for you. You can also manage your account on BT.com or using the MyBT app on your iPhone or Android mobile. To get more information about it just follow this handy link http://bt.custhelp.com/app/answers/detail/a_id/53804/~/how-to-use-the-my-bt-app`, ee_template: `Hi there, It was great to speak to you today, and I hope everything is sorted for you now. You can also manage your account on EE.co.uk or using the My EE app on your mobile. You can find more information here: https://ee.co.uk/myee/app` }
        ]
    };

    // --- APPLICATION STATE ---
    const selections = {
        type: null,
        brand: null,
        category: null,
        contact: null,
        scenarioId: null,
    };

    // --- ELEMENT REFERENCES ---
    const appContainer = document.getElementById('appContainer');
    const stepElements = {
        type: document.getElementById('step-type'),
        brand: document.getElementById('step-brand'),
        category: document.getElementById('step-category'),
        contact: document.getElementById('step-contact'),
        scenario: document.getElementById('step-scenario'),
    };
    const quickStartContainer = document.getElementById('quick-start-container');
    const quickStartBT = document.getElementById('quickStartBT');
    const quickStartEE = document.getElementById('quickStartEE');
    // ... more element refs
    const messageOutput = document.getElementById('messageOutput');
    const scenarioInput = document.getElementById('scenarioInput');
    const scenarioDropdown = document.getElementById('scenarioDropdown');
    const charCounter = document.getElementById('charCounter');
    const delayOptions = document.getElementById('delay-options');
    const callbackOptions = document.getElementById('callback-options');
    const copyButton = document.getElementById('copyButton');
    const statusMessage = document.getElementById('statusMessage');
    const delayStartDateInput = document.getElementById('delayStartDate');
    const callbackDateInput = document.getElementById('callbackDate');
    const callbackTimeInput = document.getElementById('callbackTime');
    const insertDateTimeButton = document.getElementById('insertDateTime');


    // --- MAIN UI LOGIC ---
    function updateUI() {
        const { type, brand, category, contact } = selections;
        
        // Hide quick start if a brand has been selected
        quickStartContainer.classList.toggle('hidden', !!brand);
        
        // Update theme based on brand selection
        appContainer.classList.toggle('theme-bt', brand === 'BT');
        appContainer.classList.toggle('theme-ee', brand === 'EE');

        // Sequentially show steps based on previous selections
        stepElements.brand.classList.remove('hidden'); // Brand is always visible initially
        stepElements.type.classList.toggle('hidden', !brand);
        stepElements.category.classList.toggle('hidden', type !== 'post');
        stepElements.contact.classList.toggle('hidden', !(type === 'post' && category));
        
        // Determine if we've reached the final step where the scenario list is shown
        const showScenario = (type === 'pre' && !!brand) || (type === 'post' && !!contact);
        stepElements.scenario.classList.toggle('hidden', !showScenario);

        if(!showScenario) {
            clearScenarioSelection();
        } else {
            populateDropdown();
        }
    }

    // --- DATA & MESSAGE HANDLING ---
    function populateDropdown() {
        const currentScenarios = scenarios[selections.type] || [];
        const searchTerm = scenarioInput.value.toLowerCase();

        const filtered = currentScenarios.filter(s => {
            const categoryMatch = selections.type === 'pre' || selections.category === 'All' || s.category === selections.category;
            const searchMatch = s.dropdownText.toLowerCase().includes(searchTerm);
            return categoryMatch && searchMatch;
        });

        filtered.sort((a, b) => a.dropdownText.localeCompare(b.dropdownText));

        scenarioDropdown.innerHTML = '';
        
        if (selections.type === 'post' && selections.category === 'All') {
            const grouped = filtered.reduce((acc, s) => {
                (acc[s.category] = acc[s.category] || []).push(s);
                return acc;
            }, {});
            Object.keys(grouped).sort().forEach(cat => {
                const optgroup = document.createElement('div');
                optgroup.className = 'category-label';
                optgroup.textContent = cat;
                scenarioDropdown.appendChild(optgroup);
                grouped[cat].forEach(addScenarioItem);
            });
        } else {
            filtered.forEach(addScenarioItem);
        }

        scenarioDropdown.classList.toggle('show', filtered.length > 0);
    }

    function addScenarioItem(scenario) {
        const item = document.createElement('div');
        item.textContent = scenario.dropdownText;
        item.dataset.id = scenario.id;
        item.addEventListener('click', () => {
            scenarioInput.value = scenario.dropdownText;
            selections.scenarioId = scenario.id;
            scenarioDropdown.classList.remove('show');
            generateMessage();
        });
        scenarioDropdown.appendChild(item);
    }
    
    function generateMessage() {
        if (!selections.type || !selections.scenarioId) {
            messageOutput.value = '';
            updateCharCounter();
            return;
        }
        
        const selectedScenario = scenarios[selections.type].find(s => s.id === selections.scenarioId);
        if (!selectedScenario) return;

        let message = selections.brand === 'BT' ? selectedScenario.bt_template : selectedScenario.ee_template;

        if (selections.type === 'post') {
            if (selectedScenario.delayDays > 0 && message.includes('{date}')) {
                const startDate = delayStartDateInput.value;
                const calculatedDate = formatDate(calculateWorkday(selectedScenario.delayDays, startDate));
                message = message.replace(/{date}/g, calculatedDate);
            }

            const hasGreeting = message.toLowerCase().startsWith('hi') || message.toLowerCase().startsWith('hello');
            if (selections.contact === 'No') {
                const uncapitalized = message.charAt(0).toLowerCase() + message.slice(1);
                message = `Sorry I couldn't reach you, ${uncapitalized}`;
            } else if (selections.contact === 'Yes' && !hasGreeting) {
                const uncapitalized = message.charAt(0).toLowerCase() + message.slice(1);
                message = `It was great to speak to you today. ${uncapitalized}`;
            }
        }
        
        messageOutput.value = message;
        
        // Contextual options visibility
        callbackOptions.classList.toggle('hidden', selections.scenarioId !== 'call_back');
        delayOptions.classList.toggle('hidden', !selectedScenario || selectedScenario.category !== 'Delays');

        updateCharCounter();
    }

    function clearScenarioSelection() {
        scenarioInput.value = '';
        selections.scenarioId = null;
        messageOutput.value = '';
        updateCharCounter();
        delayOptions.classList.add('hidden');
        callbackOptions.classList.add('hidden');
    }

    // --- UTILITY FUNCTIONS ---
    function updateCharCounter() {
        const len = messageOutput.value.length;
        charCounter.textContent = len > 0 ? `${len} characters (${Math.ceil(len / 160)} SMS)` : '';
    }
    function formatDate(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        return `${d}/${m}/${date.getFullYear()}`;
    }
    function calculateWorkday(daysToAdd, startDateString) {
        let currentDate = startDateString ? new Date(startDateString + 'T00:00:00') : new Date();
        let daysAdded = 0;
        while (daysAdded < daysToAdd) {
            currentDate.setDate(currentDate.getDate() + 1);
            if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                daysAdded++;
            }
        }
        return currentDate;
    }
    function populateTimeSlots(dateString) {
        callbackTimeInput.innerHTML = '';
        const date = new Date(dateString + 'T00:00:00');
        const dayOfWeek = date.getDay();
        const startHour = (dayOfWeek === 0) ? 9 : 8; // Sunday 9am, others 8am
        for (let h = startHour; h < 20; h++) {
            for (let m = 0; m < 60; m += 15) {
                const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = option.textContent = time;
                callbackTimeInput.appendChild(option);
            }
        }
    }


    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split("T")[0];
        callbackDateInput.min = today;
        callbackDateInput.value = today;
        delayStartDateInput.value = today;
        populateTimeSlots(today);
        updateUI();
    });

    // Quick Start Handlers
    function handleQuickStart(brand) {
        // Set state
        selections.brand = brand;
        selections.type = 'post';
        selections.category = 'Delays';
        selections.contact = 'Yes';

        // Check corresponding radio buttons to sync UI state
        document.getElementById(brand === 'BT' ? 'brandBT' : 'brandEE').checked = true;
        document.getElementById('typePost').checked = true;
        document.getElementById('catDelays').checked = true;
        document.getElementById('contactYes').checked = true;
        
        // Clear any leftover scenario and update the whole UI
        clearScenarioSelection();
        updateUI();
    }
    quickStartBT.addEventListener('click', () => handleQuickStart('BT'));
    quickStartEE.addEventListener('click', () => handleQuickStart('EE'));


    // Step selection handlers
    ['brand', 'type', 'category', 'contactStatus'].forEach(name => {
        document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
            radio.addEventListener('change', e => {
                const key = name === 'contactStatus' ? 'contact' : name;
                selections[key] = e.target.value;

                // For minor changes (brand, contact status) that only affect the text, just regenerate the message.
                if (key === 'brand' || key === 'contact') {
                    if (selections.scenarioId) {
                        generateMessage();
                    }
                } else {
                    // For major changes (type, category) that alter the workflow, reset subsequent steps.
                    clearScenarioSelection();

                    // When changing category, we need to reset the contact status choice.
                    if (key === 'category') {
                        selections.contact = null;
                        document.querySelectorAll('input[name="contactStatus"]').forEach(r => r.checked = false);
                    }
                    // Note: When changing type (pre/post), we now remember the category/contact selections.
                }
                
                updateUI();
            });
        });
    });


    // Scenario input handlers
    scenarioInput.addEventListener('input', populateDropdown);
    scenarioInput.addEventListener('click', () => {
        if (scenarioInput.value !== '') clearScenarioSelection();
        populateDropdown();
    });
    document.addEventListener('click', (e) => {
        if (!appContainer.contains(e.target)) scenarioDropdown.classList.remove('show');
    });

    // Contextual options handlers
    delayStartDateInput.addEventListener('change', generateMessage);
    callbackDateInput.addEventListener('change', (e) => populateTimeSlots(e.target.value));
    insertDateTimeButton.addEventListener('click', () => {
        const date = callbackDateInput.value;
        const time = callbackTimeInput.value;
        if (date && time) {
            const dateObj = new Date(date + 'T00:00:00');
            const formatted = dateObj.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            messageOutput.value += ` ${formatted} at ${time}.`;
            updateCharCounter();
        }
    });

    // Final action handlers
    copyButton.addEventListener('click', () => {
        if (messageOutput.value) {
            try {
                messageOutput.select();
                messageOutput.setSelectionRange(0, 99999);
                if (document.execCommand('copy')) {
                    statusMessage.textContent = 'Message copied to clipboard!';
                } else {
                    statusMessage.textContent = 'Failed to copy!';
                }
                window.getSelection().removeAllRanges();
            } catch (err) {
                statusMessage.textContent = 'Failed to copy!';
            } finally {
                setTimeout(() => { statusMessage.textContent = ''; }, 2000);
            }
        }
    });
    messageOutput.addEventListener('input', updateCharCounter);

</script>

</body>
</html>
